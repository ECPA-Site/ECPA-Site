<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Roblox Mobile - New Slot System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        
        /* –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ */
        #char-select { 
            position: absolute; inset: 0; background: #1a1a1a; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; 
        }
        .btn-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .hero-btn { 
            width: 140px; height: 80px; border: 3px solid #fff; border-radius: 10px;
            color: #fff; font-weight: bold; font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .red { background: red; } .brown { background: #5d4037; }
        .blue { background: blue; } .yellow { background: yellow; color: #000; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #game-ui { display: none; position: fixed; top: 10px; left: 10px; z-index: 100; color: white; pointer-events: none; }
        .bar { width: 150px; height: 10px; background: #333; margin-top: 5px; }
        #hp-fill { width: 100%; height: 100%; background: #0f0; transition: width 0.3s; }

        /* –ö–Ω–æ–ø–∫–∏ —Å–ª–æ—Ç–æ–≤ */
        #slots-open { position: fixed; top: 10px; right: 10px; z-index: 1000; padding: 10px; background: #333; color: white; border: 1px solid white; border-radius: 5px; display: none; }
        #save-menu { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); 
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 5000; color: white; 
        }
        .slot { background: #222; margin: 8px; padding: 15px; border-radius: 10px; width: 260px; border: 1px solid #444; text-align: center; }
        .slot b { color: #aaa; }
        .slot button { margin: 5px; padding: 8px 15px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; }
        .save-btn { background: #2ecc71; color: white; }
        .load-btn { background: #3498db; color: white; }

        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
        #controls { display: none; }
        #joy-zone { position: fixed; bottom: 40px; left: 40px; width: 100px; height: 100px; border: 2px solid #fff; border-radius: 50%; z-index: 10; }
        #stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.5; }
        #atk-btn { position: fixed; bottom: 40px; right: 40px; width: 80px; height: 80px; background: red; border: 3px solid #fff; border-radius: 50%; z-index: 10; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 30px; }
        
        #msg { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 4000; color: white; font-size: 30px; }
    </style>
</head>
<body>

<div id="char-select">
    <h1 style="color:white; margin-bottom: 20px;">–ù–û–í–´–ô –ò–ì–†–û–ö: –í–´–ë–ï–†–ò –ì–ï–†–û–Ø</h1>
    <div class="btn-container">
        <div class="hero-btn red" onclick="start('RedShadow', 0xff0000)">RedShadow</div>
        <div class="hero-btn brown" onclick="start('MrFlicer', 0x5d4037)">MrFlicer</div>
        <div class="hero-btn blue" onclick="start('Joper546', 0x0000ff)">Joper546</div>
        <div class="hero-btn yellow" onclick="start('Dobrikotikleast', 0xffff00)">Dobrikotikleast</div>
    </div>
    <p style="color: #666; margin-top: 20px;">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–ª–æ—Ç —á–µ—Ä–µ–∑ –º–µ–Ω—é –≤ –∏–≥—Ä–µ</p>
</div>

<div id="game-ui">
    <b id="name-tag">...</b>
    <div class="bar"><div id="hp-fill"></div></div>
    <div>üíé: <span id="coins">0</span></div>
</div>

<button id="slots-open" onclick="toggleMenu(true)">üíæ –°–õ–û–¢–´</button>

<div id="save-menu">
    <h2>–°–ò–°–¢–ï–ú–ê –°–û–•–†–ê–ù–ï–ù–ò–ô</h2>
    <div id="slots-list"></div>
    <button onclick="toggleMenu(false)" style="margin-top:20px; padding:10px 40px; background: #555; color: white; border: none; border-radius: 5px;">–ó–ê–ö–†–´–¢–¨</button>
</div>

<div id="msg">GAME OVER</div>

<div id="controls">
    <div id="joy-zone"><div id="stick"></div></div>
    <div id="atk-btn" ontouchstart="attack()">‚öîÔ∏è</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

<script>
let scene, camera, renderer, player, playerBody;
let hp = 100, coins = 0, isDead = false, currentHero = "", heroColor = 0;
let joyX = 0, joyY = 0, yaw = 0, lastX = 0, lastHit = 0;
const enemies = [], clock = new THREE.Clock();

/** --- –õ–û–ì–ò–ö–ê –°–õ–û–¢–û–í --- **/
function toggleMenu(show) {
    document.getElementById('save-menu').style.display = show ? 'flex' : 'none';
    if(show) renderSlots();
}

function saveGame(slotId) {
    if(!currentHero) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!");
        return;
    }
    const data = { 
        hp: hp, 
        coins: coins, 
        hero: currentHero, 
        color: heroColor, 
        date: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString()
    };
    localStorage.setItem('game_slot_' + slotId, JSON.stringify(data));
    renderSlots();
}

function loadGame(slotId) {
    const rawData = localStorage.getItem('game_slot_' + slotId);
    if(!rawData) return;
    
    const data = JSON.parse(rawData);
    
    // –ï—Å–ª–∏ –∏–≥—Ä–∞ –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞ (–º—ã –≤ –º–µ–Ω—é)
    if(!scene) {
        start(data.hero, data.color);
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    hp = data.hp;
    coins = data.coins;
    currentHero = data.hero;
    heroColor = data.color;
    
    document.getElementById('coins').innerText = coins;
    document.getElementById('name-tag').innerText = currentHero;
    if(playerBody) playerBody.material.color.setHex(heroColor);
    
    toggleMenu(false);
}

function renderSlots() {
    const list = document.getElementById('slots-list');
    list.innerHTML = '';
    for(let i=1; i<=4; i++) {
        const data = localStorage.getItem('game_slot_' + i);
        const d = data ? JSON.parse(data) : null;
        
        list.innerHTML += `
            <div class="slot">
                <b>–°–õ–û–¢ ${i}</b><br>
                <span style="font-size: 12px; color: ${d ? '#2ecc71' : '#666'}">
                    ${d ? d.hero + ' (üíé' + d.coins + ')<br>' + d.date : '–ü–£–°–¢–û–ô –°–õ–û–¢'}
                </span><br>
                <button class="save-btn" onclick="saveGame(${i})">–°–û–•–†–ê–ù–ò–¢–¨</button>
                ${d ? `<button class="load-btn" onclick="loadGame(${i})">–ó–ê–ì–†–£–ó–ò–¢–¨</button>` : ''}
            </div>`;
    }
}

/** --- –ó–ê–ü–£–°–ö –ò –ì–†–ê–§–ò–ö–ê --- **/
function start(name, color) {
    currentHero = name; 
    heroColor = color;
    
    document.getElementById('char-select').style.display = 'none';
    document.getElementById('game-ui').style.display = 'block';
    document.getElementById('controls').style.display = 'block';
    document.getElementById('slots-open').style.display = 'block';
    document.getElementById('name-tag').innerText = name;

    if(scene) return; // –ß—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å—Ü–µ–Ω—É –¥–≤–∞–∂–¥—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.8));
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({color: 0x27ae60}));
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    player = new THREE.Group();
    playerBody = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.4, 0.6), new THREE.MeshStandardMaterial({color: color}));
    playerBody.position.y = 0.7;
    player.add(playerBody);
    scene.add(player);

    for(let i=0; i<5; i++) spawnEnemy();
    animate();
}

function spawnEnemy() {
    const e = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.4, 0.8), new THREE.MeshStandardMaterial({color: 0x333}));
    e.position.set(Math.random()*40-20, 0.7, Math.random()*40-20);
    e.userData = { hp: 30 };
    enemies.push(e);
    scene.add(e);
}

function attack() {
    if(isDead) return;
    enemies.forEach((e, i) => {
        if(player.position.distanceTo(e.position) < 4) {
            e.userData.hp -= 15;
            if(e.userData.hp <= 0) {
                scene.remove(e); enemies.splice(i, 1);
                coins += 5; document.getElementById('coins').innerText = coins;
                setTimeout(spawnEnemy, 2000);
            }
        }
    });
}

/** --- –£–ü–†–ê–í–õ–ï–ù–ò–ï --- **/
window.addEventListener('touchstart', e => { if(e.touches[0]) lastX = e.touches[0].clientX; });
window.addEventListener('touchmove', e => {
    if(isDead || !scene) return;
    const t = e.touches[0];
    if(t.clientX < window.innerWidth / 2) {
        const r = document.getElementById('joy-zone').getBoundingClientRect();
        const dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
        const d = Math.min(Math.hypot(dx, dy), 40);
        const a = Math.atan2(dy, dx);
        joyX = Math.cos(a)*(d/40); joyY = Math.sin(a)*(d/40);
        document.getElementById('stick').style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
    } else {
        yaw -= (t.clientX - lastX) * 0.01;
        lastX = t.clientX;
    }
});
window.addEventListener('touchend', () => { joyX = 0; joyY = 0; document.getElementById('stick').style.transform = 'translate(0,0)'; });

function animate() {
    requestAnimationFrame(animate);
    const dt = clock.getDelta();

    if(!isDead && scene) {
        if(Math.abs(joyX) > 0.1 || Math.abs(joyY) > 0.1) {
            const move = new THREE.Vector3(joyX, 0, joyY);
            move.applyAxisAngle(new THREE.Vector3(0,1,0), yaw);
            player.position.addScaledVector(move, 7 * dt);
            player.rotation.y = yaw + Math.atan2(-joyX, -joyY);
        }

        if(Date.now() - lastHit > 3000 && hp < 100) hp += 5 * dt;

        enemies.forEach(e => {
            const d = player.position.distanceTo(e.position);
            if(d < 15) {
                e.lookAt(player.position.x, 0.7, player.position.z);
                e.position.addScaledVector(new THREE.Vector3().subVectors(player.position, e.position).normalize(), 3 * dt);
                if(d < 1.4) {
                    hp -= 20 * dt; lastHit = Date.now();
                    if(hp <= 0) {
                        isDead = true;
                        document.getElementById('msg').style.display = 'flex';
                        setTimeout(() => {
                            isDead = false; hp = 100; player.position.set(0,0,0);
                            document.getElementById('msg').style.display = 'none';
                        }, 3000);
                    }
                }
            }
        });
    }

    if(scene) {
        document.getElementById('hp-fill').style.width = hp + "%";
        camera.position.set(player.position.x + Math.sin(yaw)*8, player.position.y+5, player.position.z + Math.cos(yaw)*8);
        camera.lookAt(player.position.x, player.position.y+1, player.position.z);
        renderer.render(scene, camera);
    }
}
</script>
</body>
</html>
