<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        
        /* –ú–µ–Ω—é —Å–ª–æ—Ç–æ–≤ - —Ç–µ–ø–µ—Ä—å –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Å–≤–µ—Ä—Ö—É */
        #save-menu { 
            position: fixed; inset: 0; background: #1a1a1a; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5000; color: white; 
        }
        .slot { background: #222; margin: 8px; padding: 12px; border-radius: 10px; width: 280px; border: 1px solid #444; text-align: center; }
        .slot b { display: block; margin-bottom: 5px; color: #fff; }
        .slot button { margin: 5px 0; padding: 12px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; width: 100%; font-size: 14px; }
        .new-btn { background: #2ecc71; color: white; }
        .load-btn { background: #3498db; color: white; }
        .resave-btn { background: #e67e22; color: white; font-size: 11px; margin-top: 10px; }

        /* –í—ã–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ */
        #char-select { 
            position: absolute; inset: 0; background: rgba(0, 0, 0, 0.95); 
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; 
        }
        .btn-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .hero-btn { width: 130px; height: 70px; border: 2px solid #fff; border-radius: 8px; color: #fff; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .red { background: red; } .brown { background: #5d4037; }
        .blue { background: blue; } .yellow { background: yellow; color: #000; }

        /* –ò–≥—Ä–∞ */
        #game-ui { display: none; position: fixed; top: 10px; left: 10px; z-index: 100; color: white; pointer-events: none; }
        .bar { width: 150px; height: 10px; background: #333; margin-top: 5px; }
        #hp-fill { width: 100%; height: 100%; background: #0f0; transition: width 0.3s; }
        #slots-open { position: fixed; top: 10px; right: 10px; z-index: 1000; padding: 10px; background: #333; color: white; border: 1px solid white; border-radius: 5px; display: none; }
        
        #controls { display: none; }
        #joy-zone { position: fixed; bottom: 40px; left: 40px; width: 90px; height: 90px; border: 2px solid #fff; border-radius: 50%; z-index: 10; }
        #stick { position: absolute; top: 20px; left: 20px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.5; }
        #atk-btn { position: fixed; bottom: 45px; right: 45px; width: 75px; height: 75px; background: red; border: 3px solid #fff; border-radius: 50%; z-index: 10; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 30px; }
        #msg { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 4000; color: white; font-size: 30px; }
    </style>
</head>
<body>

<div id="char-select">
    <h2 style="color:white; margin-bottom: 20px;">–í–´–ë–ï–†–ò –ì–ï–†–û–Ø</h2>
    <div class="btn-container">
        <div class="hero-btn red" onclick="confirmHero('RedShadow', 0xff0000)">RedShadow</div>
        <div class="hero-btn brown" onclick="confirmHero('MrFlicer', 0x5d4037)">MrFlicer</div>
        <div class="hero-btn blue" onclick="confirmHero('Joper546', 0x0000ff)">Joper546</div>
        <div class="hero-btn yellow" onclick="confirmHero('Dobrikotikleast', 0xffff00)">Dobrikotikleast</div>
    </div>
    <button onclick="closeCharSelect()" style="margin-top: 20px; background: none; color: gray; border: none; font-size: 16px;">–û—Ç–º–µ–Ω–∞</button>
</div>

<div id="save-menu">
    <div id="slots-list"></div>
    <button id="back-to-game" onclick="toggleMenu(false)" style="margin-top:15px; padding:12px 30px; background: #444; color: white; display: none; border: none; border-radius: 5px; font-weight: bold;">–í–ï–†–ù–£–¢–¨–°–Ø</button>
</div>

<div id="game-ui">
    <b id="name-tag">...</b>
    <div class="bar"><div id="hp-fill"></div></div>
    <div>üíé: <span id="coins">0</span></div>
</div>

<button id="slots-open" onclick="toggleMenu(true)">üíæ –ú–ï–ù–Æ</button>
<div id="msg">GAME OVER</div>

<div id="controls">
    <div id="joy-zone"><div id="stick"></div></div>
    <div id="atk-btn" ontouchstart="attack()">‚öîÔ∏è</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

<script>
let scene, camera, renderer, player, playerBody;
let hp = 100, coins = 0, isDead = false, currentHero = "", heroColor = 0;
let joyX = 0, joyY = 0, yaw = 0, lastX = 0, lastHit = 0, activeSlot = null;
const enemies = [], clock = new THREE.Clock();

renderSlots();

function toggleMenu(show) {
    document.getElementById('save-menu').style.display = show ? 'flex' : 'none';
    if(show) {
        document.getElementById('back-to-game').style.display = scene ? 'block' : 'none';
        renderSlots();
    }
}

function openNewGame(slotId) {
    activeSlot = slotId;
    document.getElementById('char-select').style.display = 'flex';
}

function closeCharSelect() {
    document.getElementById('char-select').style.display = 'none';
}

function confirmHero(name, color) {
    currentHero = name; heroColor = color;
    hp = 100; coins = 0;
    saveToActiveSlot();
    document.getElementById('char-select').style.display = 'none';
    toggleMenu(false);
    if(!scene) startSystem(name, color);
    else updatePlayerVisual(name, color);
}

function saveToActiveSlot() {
    if(!activeSlot) return;
    const data = { hp, coins, hero: currentHero, color: heroColor };
    localStorage.setItem('game_slot_v2_' + activeSlot, JSON.stringify(data));
}

function loadFromSlot(slotId) {
    activeSlot = slotId;
    const data = JSON.parse(localStorage.getItem('game_slot_v2_' + slotId));
    if(data) {
        hp = data.hp; coins = data.coins; currentHero = data.hero; heroColor = data.color;
        toggleMenu(false);
        if(!scene) startSystem(data.hero, data.color);
        else updatePlayerVisual(data.hero, data.color);
        document.getElementById('coins').innerText = coins;
    }
}

function renderSlots() {
    const list = document.getElementById('slots-list');
    list.innerHTML = '';
    for(let i=1; i<=4; i++) {
        const raw = localStorage.getItem('game_slot_v2_' + i);
        const d = raw ? JSON.parse(raw) : null;
        list.innerHTML += `
            <div class="slot">
                <b>–°–õ–û–¢ ${i}</b>
                ${d ? 
                    `<small style="color:#aaa">${d.hero} | üíé ${d.coins}</small>
                     <button class="load-btn" onclick="loadFromSlot(${i})">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
                     <button class="resave-btn" onclick="openNewGame(${i})">–°–ë–†–û–°–ò–¢–¨ –ò –ù–û–í–ê–Ø –ò–ì–†–ê</button>` : 
                    `<button class="new-btn" onclick="openNewGame(${i})">+ –ù–û–í–ê–Ø –ò–ì–†–ê</button>`
                }
            </div>`;
    }
}

function updatePlayerVisual(name, color) {
    document.getElementById('name-tag').innerText = name;
    if(playerBody) playerBody.material.color.setHex(color);
}

function startSystem(name, color) {
    document.getElementById('game-ui').style.display = 'block';
    document.getElementById('controls').style.display = 'block';
    document.getElementById('slots-open').style.display = 'block';

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.8));
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({color: 0x27ae60}));
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    player = new THREE.Group();
    playerBody = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.4, 0.6), new THREE.MeshStandardMaterial({color: color}));
    playerBody.position.y = 0.7;
    player.add(playerBody);
    scene.add(player);

    for(let i=0; i<5; i++) spawnEnemy();
    animate();
    setInterval(saveToActiveSlot, 10000);
}

function spawnEnemy() {
    const e = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.4, 0.8), new THREE.MeshStandardMaterial({color: 0x333}));
    e.position.set(Math.random()*40-20, 0.7, Math.random()*40-20);
    e.userData = { hp: 30 };
    enemies.push(e);
    scene.add(e);
}

function attack() {
    if(isDead) return;
    enemies.forEach((e, i) => {
        if(player.position.distanceTo(e.position) < 4) {
            e.userData.hp -= 15;
            if(e.userData.hp <= 0) {
                scene
