<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Roblox Mobile - Regen Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: sans-serif; touch-action: none; }
        #gui { position: fixed; top: 10px; left: 10px; color: white; pointer-events: none; z-index: 10; }
        .card { background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; backdrop-filter: blur(5px); }
        .bar { width: 150px; height: 8px; background: #222; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: #00ff44; transition: width 0.3s; }
        
        #joystick-zone { position: fixed; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid white; z-index: 20; }
        #stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: white; border-radius: 50%; opacity: 0.8; pointer-events: none; }
        
        #attack-btn { position: fixed; bottom: 40px; right: 40px; width: 70px; height: 70px; background: rgba(255,0,0,0.6); border-radius: 50%; border: 3px solid white; color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; z-index: 20; }
        
        #regen-label { font-size: 10px; color: #00ff44; display: none; margin-top: 2px; }
    </style>
</head>
<body>

<div id="gui">
    <div class="card">
        <b>‚ù§Ô∏è –ñ–ò–ó–ù–¨</b>
        <div class="bar"><div id="hp-fill"></div></div>
        <div id="regen-label">–†–ï–ì–ï–ù–ï–†–ê–¶–ò–Ø...</div>
        <div style="margin-top:5px;">üíé –ö–†–ò–°–¢–ê–õ–õ–´: <span id="coins">0</span></div>
    </div>
</div>

<div id="joystick-zone"><div id="stick"></div></div>
<div id="attack-btn">‚öîÔ∏è</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

<script>
/** --- –ù–ê–°–¢–†–û–ô–ö–ò --- **/
let playerHP = 100, maxHP = 100, coins = 0;
let lastHitTime = 0; // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —É—Ä–æ–Ω–∞
let joyX = 0, joyY = 0;
let yaw = 0;
let lastTouchX = 0;
const enemies = [];

/** --- –°–¶–ï–ù–ê --- **/
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);
scene.fog = new THREE.Fog(0x87CEEB, 20, 100);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: false });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff, 0.7));
const sun = new THREE.DirectionalLight(0xffffff, 0.8);
sun.position.set(10, 20, 10);
scene.add(sun);

const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(200, 200),
    new THREE.MeshStandardMaterial({ color: 0x3ea33e })
);
ground.rotation.x = -Math.PI / 2;
scene.add(ground);

/** --- –ú–û–î–ï–õ–ò --- **/
const player = new THREE.Group();
const body = new THREE.Mesh(new THREE.BoxGeometry(0.7, 1.2, 0.5), new THREE.MeshStandardMaterial({color: 0x00d4ff}));
body.position.y = 0.6;
player.add(body);
scene.add(player);

function spawnEnemy() {
    const e = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.2, 0.8), new THREE.MeshStandardMaterial({color: 0xff4400}));
    e.position.set(Math.random()*40-20, 0.6, Math.random()*40-20);
    e.userData = { hp: 30 };
    enemies.push(e);
    scene.add(e);
}
for(let i=0; i<5; i++) spawnEnemy();

/** --- –£–ü–†–ê–í–õ–ï–ù–ò–ï --- **/
const stick = document.getElementById('stick');
const joyZone = document.getElementById('joystick-zone');

window.addEventListener('touchstart', (e) => {
    for(let i=0; i<e.touches.length; i++) {
        if(e.touches[i].clientX > window.innerWidth / 2) lastTouchX = e.touches[i].clientX;
    }
}, {passive: false});

window.addEventListener('touchmove', (e) => {
    e.preventDefault();
    for(let i=0; i<e.touches.length; i++) {
        const t = e.touches[i];
        if (t.clientX < window.innerWidth / 2) {
            const rect = joyZone.getBoundingClientRect();
            const dx = t.clientX - (rect.left + 50);
            const dy = t.clientY - (rect.top + 50);
            const dist = Math.min(Math.hypot(dx, dy), 40);
            const angle = Math.atan2(dy, dx);
            joyX = Math.cos(angle) * (dist / 40);
            joyY = Math.sin(angle) * (dist / 40);
            stick.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
        } else {
            const deltaX = t.clientX - lastTouchX;
            yaw -= deltaX * 0.007;
            lastTouchX = t.clientX;
        }
    }
}, {passive: false});

window.addEventListener('touchend', (e) => {
    if(e.touches.length === 0) {
        joyX = 0; joyY = 0;
        stick.style.transform = `translate(0,0)`;
    }
});

document.getElementById('attack-btn').addEventListener('touchstart', () => {
    enemies.forEach((e, i) => {
        if(player.position.distanceTo(e.position) < 4) {
            e.userData.hp -= 15;
            if(e.userData.hp <= 0) {
                scene.remove(e);
                enemies.splice(i, 1);
                coins += 5;
                document.getElementById('coins').innerText = coins;
                setTimeout(spawnEnemy, 2000);
            }
        }
    });
});

/** --- –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ --- **/
const clock = new THREE.Clock();
function animate() {
    requestAnimationFrame(animate);
    const dt = clock.getDelta();
    const now = Date.now();

    // 1. –î–≤–∏–∂–µ–Ω–∏–µ
    if(Math.abs(joyX) > 0.1 || Math.abs(joyY) > 0.1) {
        const move = new THREE.Vector3(joyX, 0, joyY);
        move.applyAxisAngle(new THREE.Vector3(0,1,0), yaw);
        player.position.addScaledVector(move, 8 * dt);
        player.rotation.y = yaw + Math.atan2(-joyX, -joyY);
    }

    // 2. –í—Ä–∞–≥–∏ –∏ –£—Ä–æ–Ω
    enemies.forEach(e => {
        const d = player.position.distanceTo(e.position);
        if(d < 15) {
            e.lookAt(player.position.x, 0.6, player.position.z);
            e.position.addScaledVector(new THREE.Vector3().subVectors(player.position, e.position).normalize(), 3 * dt);
            if(d < 1.4) {
                playerHP -= 10 * dt;
                lastHitTime = now; // –ó–∞—Å–µ–∫–∞–µ–º –≤—Ä–µ–º—è —É–¥–∞—Ä–∞
                if(playerHP <= 0) location.reload();
            }
        }
    });

    // 3. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –†–ï–ì–ï–ù–ï–†–ê–¶–ò–Ø
    // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 3 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ —É–¥–∞—Ä–∞ –∏ HP –º–µ–Ω—å—à–µ –º–∞–∫—Å–∏–º—É–º–∞
    if (now - lastHitTime > 3000 && playerHP < maxHP) {
        playerHP += 5 * dt; // –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–≥–µ–Ω–∞: 5 HP –≤ —Å–µ–∫.
        if (playerHP > maxHP) playerHP = maxHP;
        document.getElementById('regen-label').style.display = 'block';
    } else {
        document.getElementById('regen-label').style.display = 'none';
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–æ—Å–∫—É HP –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
    document.getElementById('hp-fill').style.width = Math.max(0, playerHP) + "%";

    // 4. –ö–∞–º–µ—Ä–∞
    const camDist = 10;
    camera.position.set(
        player.position.x + Math.sin(yaw) * camDist,
        player.position.y + 6,
        player.position.z + Math.cos(yaw) * camDist
    );
    camera.lookAt(player.position.x, player.position.y, player.position.z);

    renderer.render(scene, camera);
}
animate();

window.onresize = () => {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
};
</script>
</body>
</html>
