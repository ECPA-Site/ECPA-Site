<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Roblox Mobile - Final Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: sans-serif; touch-action: none; }
        
        /* –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ - —Ç–µ–ø–µ—Ä—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π */
        #char-select { 
            position: fixed; inset: 0; 
            background: #2c3e50; 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            z-index: 10000; color: white; 
        }
        .char-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .char-btn { 
            padding: 30px 20px; border-radius: 15px; border: 4px solid white; 
            font-weight: bold; cursor: pointer; text-align: center; width: 140px;
            font-size: 18px; pointer-events: auto;
        }
        .red { background: #e74c3c; } .brown { background: #795548; }
        .blue { background: #3498db; } .yellow { background: #f1c40f; color: black; }

        /* –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #gui, #controls, #slots-btn { display: none; }
        #gui { position: fixed; top: 10px; left: 10px; z-index: 100; color: white; pointer-events: none; }
        .hud-card { background: rgba(0,0,0,0.6); padding: 12px; border-radius: 12px; }
        .hp-bar { width: 160px; height: 12px; background: #222; border-radius: 6px; margin: 5px 0; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: #2ecc71; transition: 0.3s; }
        
        #overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
            display: none; flex-direction: column; align-items: center; 
            justify-content: center; z-index: 2000; color: white; 
            opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }

        #slots-btn { position: fixed; top: 10px; right: 10px; z-index: 101; padding: 10px; background: #000; color: white; border: 1px solid white; border-radius: 8px; }
        
        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
        #joystick { position: fixed; bottom: 50px; left: 50px; width: 100px; height: 100px; border: 2px solid white; border-radius: 50%; z-index: 50; }
        #stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: white; border-radius: 50%; opacity: 0.7; }
        #attack-btn { position: fixed; bottom: 60px; right: 50px; width: 80px; height: 80px; background: #e74c3c; border: 4px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 35px; z-index: 50; color: white; }
    </style>
</head>
<body>

<div id="char-select">
    <h1>–í–´–ë–ï–†–ò –ì–ï–†–û–Ø</h1>
    <div class="char-grid">
        <div class="char-btn red" onclick="initGame('RedShadow', 0xff0000)">RedShadow</div>
        <div class="char-btn brown" onclick="initGame('MrFlicer', 0x5d4037)">MrFlicer</div>
        <div class="char-btn blue" onclick="initGame('Joper546', 0x0000ff)">Joper546</div>
        <div class="char-btn yellow" onclick="initGame('Dobrikotikleast', 0xffff00)">Dobrikotikleast</div>
    </div>
</div>

<div id="overlay">
    <h1 id="overlay-title">GAME OVER</h1>
    <p id="overlay-sub">–í–æ—Å–∫—Ä–µ—à–µ–Ω–∏–µ...</p>
</div>

<div id="gui">
    <div class="hud-card">
        <b id="p-name">...</b>
        <div class="hp-bar"><div id="hp-fill"></div></div>
        <div id="regen-text" style="font-size:10px; color:#2ecc71; display:none;">–†–ï–ì–ï–ù–ï–†–ê–¶–ò–Ø...</div>
        <div>üíé: <span id="coin-txt">0</span> / 50</div>
    </div>
</div>

<button id="slots-btn" onclick="toggleSaveMenu(true)">üíæ –°–õ–û–¢–´</button>

<div id="controls">
    <div id="joystick"><div id="stick"></div></div>
    <div id="attack-btn" ontouchstart="handleAttack(event)">‚öîÔ∏è</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

<script>
let scene, camera, renderer, player, pMesh, boss;
let playerHP = 100, coins = 0, lastHit = 0, isDead = false;
let joyX = 0, joyY = 0, yaw = 0, lastTX = 0;
let currentHero = "", heroColor = 0;
const enemies = [], clock = new THREE.Clock();

function initGame(name, color) {
    currentHero = name; heroColor = color;
    
    // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä—É
    document.getElementById('char-select').style.display = 'none';
    document.getElementById('gui').style.display = 'block';
    document.getElementById('controls').style.display = 'block';
    document.getElementById('slots-btn').style.display = 'block';
    document.getElementById('p-name').innerText = name;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Three.js
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({color: 0x27ae60}));
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    player = new THREE.Group();
    pMesh = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.4, 0.6), new THREE.MeshStandardMaterial({color: color}));
    pMesh.position.y = 0.7;
    player.add(pMesh);
    scene.add(player);

    for(let i=0; i<5; i++) spawnEnemy();
    animate();
}

function spawnEnemy() {
    const e = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.4, 0.8), new THREE.MeshStandardMaterial({color: 0x333333}));
    e.position.set(Math.random()*60-30, 0.7, Math.random()*60-30);
    e.userData = { hp: 30 };
    enemies.push(e);
    scene.add(e);
}

function handleAttack(e) {
    if(e) e.preventDefault();
    if(isDead) return;
    enemies.forEach((en, i) => {
        if(player.position.distanceTo(en.position) < 4) {
            en.userData.hp -= 15;
            if(en.userData.hp <= 0) {
                scene.remove(en); enemies.splice(i,1);
                coins += 5; document.getElementById('coin-txt').innerText = coins;
                setTimeout(spawnEnemy, 2000);
            }
        }
    });
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π –∏ –¥–∂–æ–π—Å—Ç–∏–∫–æ–º
window.addEventListener('touchstart', e => { 
    for(let t of e.touches) if(t.clientX > window.innerWidth/2) lastTX = t.clientX; 
});

window.addEventListener('touchmove', e => {
    if(isDead || !scene) return;
    for(let t of e.touches) {
        if(t.clientX < window.innerWidth/2) {
            const r = document.getElementById('joystick').getBoundingClientRect();
            const dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
            const d = Math.min(Math.hypot(dx, dy), 40);
            const a = Math.atan2(dy, dx);
            joyX = Math.cos(a)*(d/40); joyY = Math.sin(a)*(d/40);
            document.getElementById('stick').style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
        } else {
            yaw -= (t.clientX - lastTX) * 0.008; lastTX = t.clientX;
        }
    }
}, {passive: false});

window.addEventListener('touchend', () => { joyX = 0; joyY = 0; document.getElementById('stick').style.transform = 'translate(0,0)'; });

function animate() {
    requestAnimationFrame(animate);
    const dt = clock.getDelta();
    const now = Date.now();

    if(!isDead) {
        // –î–≤–∏–∂–µ–Ω–∏–µ
        if(Math.abs(joyX)>0.1 || Math.abs(joyY)>0.1) {
            const move = new THREE.Vector3(joyX, 0, joyY);
            move.applyAxisAngle(new THREE.Vector3(0,1,0), yaw);
            player.position.addScaledVector(move, 8 * dt);
            player.rotation.y = yaw + Math.atan2(-joyX, -joyY);
        }

        // –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è
        if(now - lastHit > 3000 && playerHP < 100) {
            playerHP += 5 * dt;
            document.getElementById('regen-text').style.display = 'block';
        } else { document.getElementById('regen-text').style.display = 'none'; }

        // –í—Ä–∞–≥–∏
        enemies.forEach(e => {
            const d = player
