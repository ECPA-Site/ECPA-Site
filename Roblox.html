<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Mega Roblox 3D - Full Version</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { margin:0; overflow:hidden; background:#000; touch-action:none; font-family: 'Segoe UI', sans-serif; }
        
        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å HP –∏ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—è */
        #ui-container { position: fixed; top: 20px; left: 20px; color: white; pointer-events: none; }
        #hp-bar { font-size: 24px; font-weight: bold; margin-bottom: 10px; text-shadow: 2px 2px 4px #000; }
        #inventory { background: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); }
        
        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        #joystick { position:fixed; left:30px; bottom:30px; width:130px; height:130px; border-radius:50%; background:rgba(255,255,255,0.1); border:2px solid rgba(255,255,255,0.3); }
        #stick { position:absolute; left:40px; top:40px; width:50px; height:50px; border-radius:50%; background:white; opacity: 0.8; }
        .btn { position:fixed; right:30px; width:75px; height:75px; border-radius:50%; font-size:28px; border:none; background:rgba(255,255,255,0.2); color:white; backdrop-filter: blur(5px); cursor: pointer; }
        #jump { bottom:125px; }
        #attack { bottom:30px; background: rgba(255, 68, 68, 0.4); }

        /* –≠–∫—Ä–∞–Ω –°–º–µ—Ä—Ç–∏ */
        #death-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(139, 0, 0, 0.8); display: none; flex-direction: column; 
            align-items: center; justify-content: center; color: white; z-index: 100; 
        }
        #death-screen h1 { font-size: 48px; margin-bottom: 20px; }
        #restart-btn { padding: 15px 40px; font-size: 20px; cursor: pointer; background: white; border: none; border-radius: 30px; }
    </style>
</head>
<body>

<div id="ui-container">
    <div id="hp-bar">‚ù§Ô∏è HP: <span id="hp-val">100</span></div>
    <div id="inventory">
        <b>–†—é–∫–∑–∞–∫:</b>
        <div id="inv-list">–ü—É—Å—Ç–æ</div>
    </div>
</div>

<div id="death-screen">
    <h1>–¢–´ –ü–û–ì–ò–ë</h1>
    <button id="restart-btn" onclick="location.reload()">–í–û–ó–†–û–î–ò–¢–¨–°–Ø</button>
</div>

<div id="joystick"><div id="stick"></div></div>
<button id="jump" class="btn">üöÄ</button>
<button id="attack" class="btn">‚öîÔ∏è</button>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

<script>
// === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
let playerHP = 100;
let isDead = false;
let inventory = {};
const enemies = [];
const lootItems = [];
const keys = {};
let joyX = 0, joyY = 0;
let camAngle = 0;
let velY = 0;
let onGround = true;
let lastHitTime = 0;

// === –°–¶–ï–ù–ê ===
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);
scene.fog = new THREE.Fog(0x87ceeb, 15, 60);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
document.body.appendChild(renderer.domElement);

const clock = new THREE.Clock();

// === –°–í–ï–¢ ===
scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const sun = new THREE.DirectionalLight(0xffffff, 1);
sun.position.set(10, 25, 15);
scene.add(sun);

// === –ú–ò–† ===
const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(200, 200),
    new THREE.MeshStandardMaterial({ color: 0x27ae60 })
);
ground.rotation.x = -Math.PI / 2;
scene.add(ground);

// === –ò–ì–†–û–ö ===
const player = new THREE.Group();
const playerBody = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({ color: 0xff4444 }));
player.add(playerBody);
player.position.y = 1;
scene.add(player);

// === –§–£–ù–ö–¶–ò–ò –°–ü–ê–í–ù–ê ===
function spawnEnemy(x, z, hp = 30, scale = 1, color = 0x3333ff) {
    const e = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({ color }));
    e.position.set(x, scale, z);
    e.scale.set(scale, scale, scale);
    e.hp = hp;
    enemies.push(e);
    scene.add(e);
}

function spawnLoot(x, z, name) {
    const geo = new THREE.OctahedronGeometry(0.4, 0);
    const mat = new THREE.MeshStandardMaterial({ color: 0xffff00, emissive: 0xffaa00, emissiveIntensity: 0.5 });
    const mesh = new THREE.Mesh(geo, mat);
    mesh.position.set(x, 0.8, z);
    mesh.itemName = name;
    scene.add(mesh);
    lootItems.push(mesh);
}

// –ù–∞—á–∞–ª—å–Ω—ã–π —Å–ø–∞–≤–Ω
spawnEnemy(8, 8);
spawnEnemy(-10, 5);
spawnEnemy(0, 15, 150, 2.5, 0x111111); // –ë–æ—Å—Å

// === –ò–ù–í–ï–ù–¢–ê–†–¨ ===
function addToInventory(name) {
    inventory[name] = (inventory[name] || 0) + 1;
    const list = document.getElementById("inv-list");
    list.innerHTML = Object.keys(inventory).map(k => `<div>${k}: x${inventory[k]}</div>`).join('');
}

// === –£–ü–†–ê–í–õ–ï–ù–ò–ï ===
window.addEventListener("keydown", e => keys[e.code] = true);
window.addEventListener("keyup", e => keys[e.code] = false);

// –ú—ã—à—å/–¢–∞—á –∫–∞–º–µ—Ä—ã
let isDragging = false, lastX = 0;
window.addEventListener("mousedown", e => { isDragging = true; lastX = e.clientX; });
window.addEventListener("mouseup", () => isDragging = false);
window.addEventListener("mousemove", e => { if(isDragging) { camAngle -= (e.clientX - lastX) * 0.007; lastX = e.clientX; } });

// –î–∂–æ–π—Å—Ç–∏–∫
const joy = document.getElementById("joystick");
const stick = document.getElementById("stick");
function moveJoy(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const r = joy.getBoundingClientRect();
    const x = touch.clientX - r.left - 65;
    const y = touch.clientY - r.top - 65;
    const d = Math.min(40, Math.hypot(x, y));
    const a = Math.atan2(y, x);
    joyX = Math.cos(a) * (d / 40);
    joyY = Math.sin(a) * (d / 40);
    stick.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
}
joy.addEventListener("touchstart", moveJoy);
joy.addEventListener("touchmove", moveJoy);
joy.addEventListener("touchend", () => { joyX = joyY = 0; stick.style.transform = "translate(0,0)"; });

// –ö–Ω–æ–ø–∫–∏
document.getElementById("jump").onclick = () => { if(onGround && !isDead) { velY = 0.25; onGround = false; } };
document.getElementById("attack").onclick = () => { if(!isDead) attack(); };

function attack() {
    enemies.forEach((e, i) => {
        if (player.position.distanceTo(e.position) < 3.5) {
            e.hp -= 20;
            e.material.color.set(0xffffff);
            setTimeout(() => e.material.color.set(e.hp < 50 ? 0xff0000 : 0x3333ff), 100);
            if (e.hp <= 0) {
                spawnLoot(e.position.x, e.position.z, "–ó–æ–ª–æ—Ç–æ");
                scene.remove(e);
                enemies.splice(i, 1);
            }
        }
    });
}

// === –¶–ò–ö–õ –û–ë–ù–û–í–õ–ï–ù–ò–Ø ===
function update() {
    if (isDead) return;

    const delta = clock.getDelta();
    const speed = 7 * delta;

    // –î–≤–∏–∂–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–∞–º–µ—Ä—ã
    const forward = new THREE.Vector3(Math.sin(camAngle), 0, Math.cos(camAngle));
    const right = new THREE.Vector3(Math.sin(camAngle + Math.PI/2), 0, Math.cos(camAngle + Math.PI/2));

    if (keys["KeyW"]) player.position.addScaledVector(forward, -speed);
    if (keys["KeyS"]) player.position.addScaledVector(forward, speed);
    if (keys["KeyA"]) player.position.addScaledVector(right, -speed);
    if (keys["KeyD"]) player.position.addScaledVector(right, speed);
    
    player.position.addScaledVector(forward, -joyY * speed);
    player.position.addScaledVector(right, joyX * speed);

    // –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
    velY -= 0.6 * delta;
    player.position.y += velY;
    if (player.position.y <= 1) { player.position.y = 1; velY = 0; onGround = true; }

    // –í—Ä–∞–≥–∏
    enemies.forEach(e => {
        const dist = player.position.distanceTo(e.position);
        if (dist < 15) {
            e.lookAt(player.position.x, e.position.y, player.position.z);
            const dir = new THREE.Vector3().subVectors(player.position, e.position).normalize();
            e.position.addScaledVector(dir, 2.5 * delta);

            if (dist < 1.5 && performance.now() - lastHitTime > 800) {
                playerHP -= 15;
                lastHitTime = performance.now();
                document.getElementById("hp-val").textContent = Math.max(0, playerHP);
                if (playerHP <= 0) die();
            }
        }
    });

    // –õ—É—Ç
    lootItems.forEach((item, i) => {
        item.rotation.y += 0.04;
        if (player.position.distanceTo(item.position) < 1.5) {
            addToInventory(item.itemName);
            scene.remove(item);
            lootItems.splice(i, 1);
        }
    });

    // –ö–∞–º–µ—Ä–∞
    camera.position.set(player.position.x + Math.sin(camAngle)*10, player.position.y + 6, player.position.z + Math.cos(camAngle)*10);
    camera.lookAt(player.position);
}

function die() {
    isDead = true;
    document.getElementById("death-screen").style.display = "flex";
}

function animate() {
    requestAnimationFrame(animate);
    update();
    renderer.render(scene, camera);
}

animate();

window.onresize = () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
};
</script>
</body>
</html>
