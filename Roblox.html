<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Roblox Mobile Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: sans-serif; touch-action: none; }
        #gui { position: fixed; top: 10px; left: 10px; color: white; pointer-events: none; z-index: 10; font-size: 14px; }
        .card { background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; backdrop-filter: blur(5px); }
        .bar { width: 150px; height: 8px; background: #222; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: #00ff44; transition: 0.3s; }
        
        /* –°—Ç–∏–∫–∏ –∏ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –º–æ–±–∏–ª–æ–∫ */
        #joystick-zone { position: fixed; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); }
        #stick { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: white; border-radius: 50%; opacity: 0.8; }
        
        #attack-btn { position: fixed; bottom: 50px; right: 40px; width: 80px; height: 80px; background: rgba(255,0,0,0.6); border-radius: 50%; border: 4px solid white; color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; user-select: none; }

        #boss-ui { position: fixed; top: 10px; right: 10px; display: none; }
    </style>
</head>
<body>

<div id="gui">
    <div class="card">
        <b>‚ù§Ô∏è –ñ–ò–ó–ù–¨</b>
        <div class="bar"><div id="hp-fill"></div></div>
        <div style="margin-top:5px;">üíé –ö–†–ò–°–¢–ê–õ–õ–´: <span id="coins">0</span> / 50</div>
    </div>
</div>

<div id="boss-ui" class="card">
    <b style="color: #ff0055;">–ë–û–°–° –ê–ö–¢–ò–í–ï–ù</b>
    <div class="bar"><div id="boss-hp-fill" style="width:100%; background:#ff0055;"></div></div>
</div>

<div id="joystick-zone"><div id="stick"></div></div>
<div id="attack-btn">‚öîÔ∏è</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

<script>
/** --- –ù–ê–°–¢–†–û–ô–ö–ò --- **/
let playerHP = 100, coins = 0, isDead = false, bossActive = false;
const enemies = [];
let joyX = 0, joyY = 0;
let yaw = 0, pitch = 0.3;

/** --- –°–¶–ï–ù–ê --- **/
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB); // –ì–æ–ª—É–±–æ–µ –Ω–µ–±–æ
scene.fog = new THREE.Fog(0x87CEEB, 20, 100);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: false }); // –û—Ç–∫–ª—é—á–∞–µ–º —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
document.body.appendChild(renderer.domElement);

const ambient = new THREE.AmbientLight(0xffffff, 0.7);
scene.add(ambient);
const sun = new THREE.DirectionalLight(0xffffff, 0.8);
sun.position.set(10, 20, 10);
scene.add(sun);

// –ó–µ–ª–µ–Ω–∞—è —Ç—Ä–∞–≤–∞
const groundGeo = new THREE.PlaneGeometry(200, 200);
const groundMat = new THREE.MeshStandardMaterial({ color: 0x2d9e2d }); // –ù–∞—Å—ã—â–µ–Ω–Ω—ã–π –∑–µ–ª–µ–Ω—ã–π
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI / 2;
scene.add(ground);

/** --- –ú–û–î–ï–õ–ò --- **/
function createModel(color, hasWeapon = false) {
    const group = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(0.7, 1, 0.5), new THREE.MeshStandardMaterial({color}));
    body.position.y = 0.5;
    group.add(body);
    const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), new THREE.MeshStandardMaterial({color}));
    head.position.y = 1.3;
    group.add(head);
    if(hasWeapon) {
        const weapon = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.1, 1), new THREE.MeshStandardMaterial({color: 0xff0000}));
        weapon.position.set(0.5, 0.5, 0.3);
        group.add(weapon);
    }
    return group;
}

const player = createModel(0x00f2ff);
scene.add(player);

function spawnEnemy() {
    const e = createModel(0xff4400, true);
    e.position.set(Math.random()*60-30, 0, Math.random()*60-30);
    e.userData = { hp: 30 };
    enemies.push(e);
    scene.add(e);
}
for(let i=0; i<6; i++) spawnEnemy();

/** --- –ú–û–ë–ò–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï --- **/
const stick = document.getElementById('stick');
const joyZone = document.getElementById('joystick-zone');

// –î–∂–æ–π—Å—Ç–∏–∫ (–õ–µ–≤–∞—è —Ä—É–∫–∞)
window.addEventListener('touchstart', (e) => {
    handleTouch(e);
}, {passive: false});

window.addEventListener('touchmove', (e) => {
    e.preventDefault();
    handleTouch(e);
}, {passive: false});

window.addEventListener('touchend', () => {
    joyX = 0; joyY = 0;
    stick.style.transform = `translate(0px, 0px)`;
}, {passive: false});

function handleTouch(e) {
    for (let i = 0; i < e.touches.length; i++) {
        const touch = e.touches[i];
        const rect = joyZone.getBoundingClientRect();
        
        // –ï—Å–ª–∏ —Ç–∞—á –≤ –∑–æ–Ω–µ –¥–∂–æ–π—Å—Ç–∏–∫–∞
        if (touch.clientX < window.innerWidth / 2) {
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const dx = touch.clientX - centerX;
            const dy = touch.clientY - centerY;
            const dist = Math.min(Math.hypot(dx, dy), 40);
            const angle = Math.atan2(dy, dx);
            
            joyX = Math.cos(angle) * (dist / 40);
            joyY = Math.sin(angle) * (dist / 40);
            
            stick.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
        } else {
            // –ï—Å–ª–∏ —Ç–∞—á –≤ –ø—Ä–∞–≤–æ–π —á–∞—Å—Ç–∏ —ç–∫—Ä–∞–Ω–∞ ‚Äî –≤—Ä–∞—â–∞–µ–º –∫–∞–º–µ—Ä—É
            if (e.type === 'touchmove') {
                // –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª–æ–∫
                yaw -= 0.05 * (touch.force || 1); // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —Ç—É—Ç –Ω—É–∂–Ω–∞ –¥–µ–ª—å—Ç–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            }
        }
    }
}

// –ö–Ω–æ–ø–∫–∞ –∞—Ç–∞–∫–∏
document.getElementById('attack-btn').addEventListener('touchstart', (e) => {
    e.preventDefault();
    performAttack();
});

// –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–¥–ª—è –ü–ö)
const keys = {};
window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => keys[e.code] = false);

function performAttack() {
    enemies.forEach((e, i) => {
        if(player.position.distanceTo(e.position) < 4) {
            e.userData.hp -= 15;
            if(e.userData.hp <= 0) {
                scene.remove(e);
                enemies.splice(i, 1);
                coins += 5;
                document.getElementById('coins').innerText = coins;
                setTimeout(spawnEnemy, 2000);
            }
        }
    });
}

/** --- –¶–ò–ö–õ –ò–ì–†–´ --- **/
const clock = new THREE.Clock();
function animate() {
    requestAnimationFrame(animate);
    const dt = clock.getDelta();
    if(isDead) return;

    // –î–≤–∏–∂–µ–Ω–∏–µ (–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ + –î–∂–æ–π—Å—Ç–∏–∫)
    const move = new THREE.Vector3();
    if(keys['KeyW']) move.z -= 1;
    if(keys['KeyS']) move.z += 1;
    if(keys['KeyA']) move.x -= 1;
    if(keys['KeyD']) move.x += 1;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–∂–æ–π—Å—Ç–∏–∫
    move.x += joyX;
    move.z += joyY;

    if(move.length() > 0.1) {
        move.applyAxisAngle(new THREE.Vector3(0,1,0), yaw);
        player.position.addScaledVector(move.normalize(), 8 * dt);
        player.rotation.y = yaw;
    }

    // –í—Ä–∞–≥–∏
    enemies.forEach(e => {
        const d = player.position.distanceTo(e.position);
        if(d < 15) {
            e.lookAt(player.position.x, 0, player.position.z);
            e.position.addScaledVector(new THREE.Vector3().subVectors(player.position, e.position).normalize(), 3 * dt);
            if(d < 1.4) {
                playerHP -= 5 * dt;
                document.getElementById('hp-fill').style.width = playerHP + "%";
                if(playerHP <= 0) { alert("–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê"); location.reload(); }
            }
        }
    });

    // –ö–∞–º–µ—Ä–∞ (—Å–ª–µ–¥—É–µ—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º)
    const dist = 8;
    camera.position.set(
        player.position.x + Math.sin(yaw) * dist,
        player.position.y + 5,
        player.position.z + Math.cos(yaw) * dist
    );
    camera.lookAt(player.position.x, player.position.y, player.position.z);

    renderer.render(scene, camera);
}
animate();

window.onresize = () => {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
};
</script>
</body>
</html>
