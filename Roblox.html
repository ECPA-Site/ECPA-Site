<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Roblox 3D: Boss Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { margin:0; overflow:hidden; background:#000; font-family: 'Courier New', monospace; }
        #gui { position: fixed; top: 20px; left: 20px; color: white; pointer-events: none; z-index: 10; }
        .card { background: rgba(0,0,0,0.8); padding: 15px; border: 2px solid #00f2ff; border-radius: 5px; box-shadow: 0 0 15px #00f2ff; }
        .bar { width: 250px; height: 12px; background: #222; border: 1px solid #fff; margin-top: 5px; }
        #hp-fill { width: 100%; height: 100%; background: #00ff44; transition: 0.2s; }
        #boss-ui { display: none; position: fixed; top: 20px; right: 20px; text-align: right; }
        #boss-hp-fill { width: 100%; height: 100%; background: #ff00ea; }
        #hint { position: fixed; bottom: 20px; width: 100%; text-align: center; color: #00f2ff; font-size: 14px; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="gui">
    <div class="card">
        <div style="font-weight: bold;">[ PLAYER_STATUS ]</div>
        <div class="bar"><div id="hp-fill"></div></div>
        <div style="margin-top: 10px;">CRYSTALS: <span id="coins">0</span> / 50</div>
    </div>
</div>

<div id="boss-ui" class="card">
    <div style="color: #ff00ea; font-weight: bold;">CRIMSON BOSS ACTIVE</div>
    <div class="bar" style="width: 300px;"><div id="boss-hp-fill"></div></div>
</div>

<div id="hint">Клик для захвата камеры | WASD - Бег | Клик мыши - Меч</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

<script>
/** --- CONFIG --- **/
let playerHP = 100, coins = 0, isDead = false, bossActive = false;
const enemies = [], bullets = [];

/** --- SCENE SETUP --- **/
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x050508);
scene.fog = new THREE.FogExp2(0x050508, 0.03);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

const light = new THREE.PointLight(0x00f2ff, 1.5, 50);
scene.add(light);
const sun = new THREE.DirectionalLight(0xffffff, 0.5);
sun.position.set(10, 20, 10);
sun.castShadow = true;
scene.add(sun);

const ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({color: 0x111111}));
ground.rotation.x = -Math.PI/2;
ground.receiveShadow = true;
scene.add(ground);
scene.add(new THREE.GridHelper(200, 40, 0x00f2ff, 0x050505));

/** --- MODELS --- **/
function createCharacter(color, isEnemy = false) {
    const group = new THREE.Group();
    // Тело
    const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.8, 0.4), new THREE.MeshStandardMaterial({color}));
    body.position.y = 0.8;
    body.castShadow = true;
    group.add(body);
    // Голова
    const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), new THREE.MeshStandardMaterial({color}));
    head.position.y = 1.45;
    group.add(head);
    // Оружие (Меч)
    const weaponGeo = new THREE.CylinderGeometry(0.05, 0.05, 1.5);
    const weaponMat = new THREE.MeshStandardMaterial({
        color: isEnemy ? 0xff0000 : 0x00f2ff, 
        emissive: isEnemy ? 0xff0000 : 0x00f2ff,
        emissiveIntensity: 2
    });
    const sword = new THREE.Mesh(weaponGeo, weaponMat);
    sword.rotation.z = Math.PI/2;
    sword.position.set(0.6, 1, 0.3);
    group.add(sword);
    
    return group;
}

const player = createCharacter(0x00f2ff);
scene.add(player);

function spawnEnemy() {
    const e = createCharacter(0xff3300, true);
    e.position.set((Math.random()-0.5)*40, 0, (Math.random()-0.5)*40);
    e.userData = { hp: 40, state: 'idle', lastAttack: 0 };
    enemies.push(e);
    scene.add(e);
}

let boss;
function spawnBoss() {
    bossActive = true;
    document.getElementById('boss-ui').style.display = 'block';
    boss = new THREE.Group();
    const bBody = new THREE.Mesh(new THREE.BoxGeometry(4, 5, 2), new THREE.MeshStandardMaterial({color: 0x330033}));
    bBody.position.y = 2.5;
    boss.add(bBody);
    
    // "Пушки" босса
    const gun = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 2), new THREE.MeshStandardMaterial({color: 0x000000}));
    gun.rotation.x = Math.PI/2;
    gun.position.set(2.5, 3, 1);
    boss.add(gun);

    boss.position.set(0, 0, -30);
    boss.userData = { hp: 500, maxHp: 500, lastShot: 0 };
    scene.add(boss);
}

for(let i=0; i<6; i++) spawnEnemy();

/** --- LOGIC --- **/
let yaw = 0, pitch = 0, keys = {};
document.addEventListener('mousedown', () => document.body.requestPointerLock());
document.addEventListener('mousemove', (e) => {
    if(document.pointerLockElement) {
        yaw -= e.movementX * 0.003;
        pitch = Math.max(-0.8, Math.min(0.8, pitch - e.movementY * 0.003));
    }
});
window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => keys[e.code] = false);

// Атака игрока
window.addEventListener('click', () => {
    if(!document.pointerLockElement) return;
    player.children[2].rotation.x += 1; // Анимация меча
    setTimeout(() => player.children[2].rotation.x -= 1, 100);

    enemies.forEach((e, i) => {
        if(player.position.distanceTo(e.position) < 3.5) {
            e.userData.hp -= 20;
            e.position.addScaledVector(new THREE.Vector3().subVectors(e.position, player.position).normalize(), 1.5);
            if(e.userData.hp <= 0) {
                scene.remove(e);
                enemies.splice(i, 1);
                coins += 5;
                document.getElementById('coins').innerText = coins;
                if(coins >= 50 && !bossActive) spawnBoss();
                setTimeout(spawnEnemy, 3000);
            }
        }
    });

    if(bossActive && player.position.distanceTo(boss.position) < 8) {
        boss.userData.hp -= 10;
        document.getElementById('boss-hp-fill').style.width = (boss.userData.hp/boss.userData.maxHp*100) + "%";
        if(boss.userData.hp <= 0) {
            alert("БОСС ПОВЕРЖЕН! МИР СПАСЕН!");
            location.reload();
        }
    }
});

const clock = new THREE.Clock();
function update() {
    const dt = clock.getDelta();
    if(playerHP <= 0) return;

    // Движение игрока
    const moveDir = new THREE.Vector3();
    if(keys['KeyW']) moveDir.z -= 1;
    if(keys['KeyS']) moveDir.z += 1;
    if(keys['KeyA']) moveDir.x -= 1;
    if(keys['KeyD']) moveDir.x += 1;
    moveDir.applyAxisAngle(new THREE.Vector3(0,1,0), yaw);
    player.position.addScaled
